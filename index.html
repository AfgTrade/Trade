<!--
Single-file demo app: Firebase-authenticated wallet top-ups via Cryptomus (USDT BEP20)
-------------------------------------------------------------------------------------------------
WHAT'S INSIDE
1) index.html  — Frontend (Tailwind UI + Firebase Auth + Realtime DB). Calls your backend proxy.
2) server.js   — Minimal Node/Express proxy + webhook to talk to Cryptomus securely (DON'T put API keys in frontend!)

HOW TO RUN (quick start)
A) Backend
   1. Save the server.js section below into a separate file named server.js
   2. npm init -y && npm i express cors body-parser node-fetch md5 firebase-admin
   3. Fill CRYPTOMUS_API_KEY and MERCHANT_UUID in server.js (you provided API key). Set PORT & BASE_URL if you wish.
   4. Configure Firebase Admin: add your service account JSON and set GOOGLE_APPLICATION_CREDENTIALS env var,
      or paste the service account object inline as shown in comments.
   5. node server.js

B) Frontend
   1. Keep this entire file as index.html and open it in a browser (or serve statically).
   2. Make sure the FRONTEND_PROXY_BASE in the JS points to your backend, e.g. http://localhost:3000

NOTES
- We use Cryptomus "Static wallet" endpoint so each Add Funds creates a dedicated USDT(BEP20) address.
- The webhook from Cryptomus credits the user's balance in Firebase when funds arrive.
- If you'd rather lock a specific amount/address pair, switch to the "Invoice" endpoint in server.js (comment included).
- Tested layout: modern, mobile-friendly. Tailwind via CDN. 
-------------------------------------------------------------------------------------------------
--><!DOCTYPE html><html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wallet Top‑Up (USDT BEP20) — Cryptomus + Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;background:#0b0f1a;color:#e6ebff}
    .card{background:#12182a;border:1px solid rgba(255,255,255,.06);box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .glass{backdrop-filter: blur(10px); background: rgba(255,255,255,0.06)}
    input,button{border-radius:14px}
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>
  <!-- QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="min-h-screen">
  <div class="max-w-5xl mx-auto py-10 px-4">
    <header class="flex items-center justify-between mb-8">
      <h1 class="text-2xl md:text-3xl font-bold">کیف پول ساده — USDT (BEP20)</h1>
      <div id="authBox" class="text-sm"></div>
    </header><!-- Auth Card -->
<div id="authCard" class="card rounded-2xl p-6 mb-8">
  <h2 class="text-xl font-semibold mb-4">ننوتل یا حساب جوړول</h2>
  <div class="grid md:grid-cols-2 gap-4">
    <input id="email" type="email" placeholder="ایمیل" class="w-full p-3 bg-[#0e1424] border border-white/10 focus:outline-none"/>
    <input id="password" type="password" placeholder="پاسورډ" class="w-full p-3 bg-[#0e1424] border border-white/10 focus:outline-none"/>
  </div>
  <div class="flex flex-wrap gap-3 mt-4">
    <button id="btnSignUp" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 transition font-semibold">اکاونټ جوړ کړه</button>
    <button id="btnSignIn" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 transition font-semibold">ننوتل</button>
    <button id="btnSignOut" class="px-4 py-2 bg-rose-500 hover:bg-rose-600 transition font-semibold hidden">وتل</button>
  </div>
  <p class="text-amber-300 text-sm mt-3">یادونه: لومړی باید د ایمیل/پاسورډ له لارې ننوتل/حساب جوړ کړئ.</p>
</div>

<!-- Dashboard -->
<section id="dash" class="hidden">
  <div class="grid md:grid-cols-3 gap-6">
    <div class="card rounded-2xl p-6 md:col-span-1">
      <h3 class="text-lg font-semibold mb-2">ستاسو بیلانس</h3>
      <div class="text-4xl font-bold" id="balance">0.00 <span class="text-base font-semibold">USDT</span></div>
      <p class="text-white/70 mt-2 text-sm">شبکه: <b>BEP20 (BSC)</b></p>
    </div>

    <div class="card rounded-2xl p-6 md:col-span-2">
      <h3 class="text-lg font-semibold mb-3">فاند اضافه کول</h3>
      <div class="grid md:grid-cols-4 gap-3 items-center">
        <label class="md:col-span-1 text-sm">مقدار (USDT):</label>
        <input id="amount" type="number" min="1" step="0.01" class="md:col-span-2 p-3 bg-[#0e1424] border border-white/10 focus:outline-none" placeholder="لکه 25"/>
        <button id="btnAdd" class="md:col-span-1 px-4 py-2 bg-sky-500 hover:bg-sky-600 font-semibold">Add</button>
      </div>
      <p class="text-xs text-white/70 mt-3">د Add کلیک وروسته، د Cryptomus له لارې د USDT(BEP20) ادرس تولیدیږي. ورته مقدار واستوئ؛ کله چې تایید شي، بیلانس اتومات اپډیټ کېږي.</p>
    </div>
  </div>

  <div id="depositCard" class="card rounded-2xl p-6 mt-6 hidden">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">د ډیپازیت جزییات</h3>
      <button id="btnCloseDeposit" class="text-sm text-white/70 hover:text-white">بندول</button>
    </div>
    <div class="grid md:grid-cols-2 gap-6 mt-4">
      <div>
        <p class="text-sm text-white/70">د تادیې ادرس (USDT / BEP20):</p>
        <div class="mt-2 p-3 bg-[#0e1424] border border-white/10 rounded-xl break-all" id="payAddress">—</div>
        <div class="mt-3 flex gap-3">
          <button id="copyAddr" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-sm">Copy</button>
          <a id="payLink" href="#" target="_blank" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-sm">د تادیې پاڼه</a>
        </div>
      </div>
      <div>
        <p class="text-sm text-white/70">QR:</p>
        <div id="qrcode" class="mt-2 bg-white rounded-xl p-2 w-[220px]"></div>
      </div>
    </div>
  </div>

  <div class="card rounded-2xl p-6 mt-6">
    <h3 class="text-lg font-semibold mb-3">د ډیپازیت ریکارډونه</h3>
    <div id="deposits" class="space-y-2 text-sm"></div>
  </div>
</section>

  </div><script>
// ====== CONFIG ======
const FRONTEND_PROXY_BASE = 'http://localhost:3000'; // Your Express server

// Firebase config (provided)
const firebaseConfig = {
  apiKey: "AIzaSyD4UbW_Iy4kUWH3V70Q1mWCI4-_KFk6ku4",
  authDomain: "onlinewark-a0147.firebaseapp.com",
  databaseURL: "https://onlinewark-a0147-default-rtdb.firebaseio.com",
  projectId: "onlinewark-a0147",
  storageBucket: "onlinewark-a0147.appspot.com",
  messagingSenderId: "92155538620",
  appId: "1:92155538620:android:5e198a8eea6bf17f61f4b9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// UI helpers
const $ = (id)=>document.getElementById(id);
const toast = (msg)=>{
  const el=document.createElement('div');
  el.className='fixed bottom-6 left-1/2 -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-xl';
  el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),3000);
}

// Auth actions
$('btnSignUp').onclick = async ()=>{
  const email=$('email').value.trim(); const pass=$('password').value;
  try{ await auth.createUserWithEmailAndPassword(email,pass); toast('اکاونټ جوړ شو'); }
  catch(e){ toast(e.message) }
}
$('btnSignIn').onclick = async ()=>{
  const email=$('email').value.trim(); const pass=$('password').value;
  try{ await auth.signInWithEmailAndPassword(email,pass); toast('بریالي ننوتل'); }
  catch(e){ toast(e.message) }
}
$('btnSignOut').onclick = ()=> auth.signOut();

// Realtime listeners
let userRef=null, depsRef=null;
auth.onAuthStateChanged(async (u)=>{
  if(u){
    $('authCard').classList.add('hidden');
    $('dash').classList.remove('hidden');
    $('btnSignOut').classList.remove('hidden');
    $('authBox').innerHTML = `<span class="opacity-80 text-xs">${u.email}</span>`;
    userRef = db.ref(`users/${u.uid}`);
    depsRef = db.ref(`deposits/${u.uid}`);

    // init defaults
    userRef.child('balance').once('value').then(s=>{ if(s.val()==null) userRef.update({balance:0}); });

    // subscribe balance
    userRef.child('balance').on('value', s=>{ const b=(s.val()||0).toFixed(2); $('balance').innerHTML = `${b} <span class="text-base font-semibold">USDT</span>`; });

    // render deposits
    depsRef.on('value', s=>{
      const data=s.val()||{}; const list=Object.values(data).sort((a,b)=>b.created-a.created);
      $('deposits').innerHTML = list.map(d=>`<div class="glass rounded-xl p-3 flex flex-wrap gap-3 items-center">
        <div class="grow">
          <div class="font-semibold">${d.amount} USDT — <span class="uppercase">${d.network}</span></div>
          <div class="text-white/70">Status: <b>${d.status}</b> • <span class="break-all">${d.address||''}</span></div>
        </div>
        ${d.url?`<a class="text-sky-300 underline" target="_blank" href="${d.url}">Pay page</a>`:''}
      </div>`).join('');
    });
  } else {
    $('dash').classList.add('hidden');
    $('authCard').classList.remove('hidden');
    $('btnSignOut').classList.add('hidden');
    $('authBox').innerHTML = '';
    if(userRef){userRef.off();} if(depsRef){depsRef.off();}
  }
});

// Add Funds -> create static wallet via backend
$('btnAdd').onclick = async ()=>{
  const u = auth.currentUser; if(!u) return toast('لومړی ننوتل');
  const amount = parseFloat($('amount').value||'0');
  if(!(amount>0)) return toast('مقدار صحیح داخل کړئ');
  $('btnAdd').disabled = true; $('btnAdd').textContent = 'در حال ایجاد...';
  try{
    const res = await fetch(`${FRONTEND_PROXY_BASE}/api/create-static`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId:u.uid, amount, currency:'USDT', network:'bsc' })
    });
    const j = await res.json();
    if(!res.ok) throw new Error(j.message||'Error');

    // save a local pending deposit record (server also writes on webhook)
    const dep = { id:j.id, amount, currency:'USDT', network:'bsc', address:j.address, url:j.url, status:'waiting', created:Date.now() };
    await db.ref(`deposits/${u.uid}/${dep.id}`).set(dep);

    // show UI
    $('payAddress').textContent = j.address;
    $('payLink').href = j.url;
    $('depositCard').classList.remove('hidden');
    $('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: j.address, width: 200, height: 200 });
    toast('ادرس جوړ شو — لطفاً تادیه وکړئ');
  } catch(e){ console.error(e); toast(e.message) }
  finally{ $('btnAdd').disabled=false; $('btnAdd').textContent='Add'; }
}

$('btnCloseDeposit').onclick = ()=> $('depositCard').classList.add('hidden');
$('copyAddr').onclick = ()=> { navigator.clipboard.writeText($('payAddress').textContent); toast('کاپي شو'); };
</script><!-- ===================== BACKEND (save as server.js) ===================== --><script type="text/plain" id="serverjs">
/**
 * Minimal Express proxy + webhook for Cryptomus (Business API)
 * SECURITY: Never expose your API key in the browser. Keep this server private.
 */

import express from 'express';
import cors from 'cors';
import bodyParser from 'body-parser';
import fetch from 'node-fetch';
import md5 from 'md5';
import admin from 'firebase-admin';

// ---- Config (FILL THESE) ----
const CRYPTOMUS_API_KEY = 'REPLACE_WITH_YOUR_CRYPTOMUS_API_KEY'; // you provided one
const MERCHANT_UUID     = 'REPLACE_WITH_YOUR_MERCHANT_UUID';     // find in Cryptomus merchant settings
const PORT = process.env.PORT || 3000;
const BASE_URL = process.env.BASE_URL || `http://localhost:${PORT}`; // public URL for webhook during dev use ngrok

// Firebase Admin (use service account)
// Option A: GOOGLE_APPLICATION_CREDENTIALS env var -> path to service account JSON
// Option B: paste credential inline
if (!admin.apps.length) {
  try {
    admin.initializeApp({
      credential: admin.credential.applicationDefault(),
      databaseURL: 'https://onlinewark-a0147-default-rtdb.firebaseio.com'
    });
  } catch (e) {
    console.error('Firebase Admin init failed. Set GOOGLE_APPLICATION_CREDENTIALS or inline creds.');
    throw e;
  }
}
const rtdb = admin.database();

const app = express();
app.use(cors());
app.use(bodyParser.json({ type: '*/*' }));

// Helper: make signed POST to Cryptomus
async function cryptomusPost(path, payload={}){
  const body = JSON.stringify(payload);
  const sign = md5(Buffer.from(body).toString('base64') + CRYPTOMUS_API_KEY);
  const res = await fetch(`https://api.cryptomus.com${path}`,{
    method:'POST', headers:{
      'Content-Type':'application/json',
      'merchant': MERCHANT_UUID,
      'sign': sign
    }, body
  });
  const json = await res.json();
  if(!res.ok || json.state!==0){
    const msg = json?.message || JSON.stringify(json);
    throw new Error(msg);
  }
  return json.result;
}

// API: create static wallet for a user (USDT on BSC by default)
app.post('/api/create-static', async (req, res)=>{
  try{
    const { userId, amount, currency='USDT', network='bsc' } = req.body || {};
    if(!userId) return res.status(400).json({message:'userId required'});

    // Create a unique order_id to tie static wallet to this deposit
    const order_id = `${userId}-${Date.now()}`;

    const result = await cryptomusPost('/v1/wallet', {
      currency, network, order_id,
      url_callback: `${BASE_URL}/api/cryptomus/webhook`
    });

    // Pre-create a pending deposit record (optional; webhook will upsert too)
    const deposit = {
      id: order_id,
      userId,
      amount: Number(amount)||0,
      currency, network,
      address: result.address,
      url: result.url,
      status: 'waiting',
      created: Date.now()
    };
    await rtdb.ref(`deposits/${userId}/${order_id}`).set(deposit);

    res.json({ id: order_id, address: result.address, url: result.url });
  }catch(e){ console.error(e); res.status(400).json({message: e.message}); }
});

// OPTIONAL: If you prefer amount-locked address, use invoice creation
// app.post('/api/create-invoice', async (req,res)=>{
//   try{
//     const { userId, amount, currency='USDT', network='bsc' } = req.body || {};
//     if(!userId || !amount) return res.status(400).json({message:'userId & amount required'});
//     const order_id = `${userId}-${Date.now()}`;
//     const result = await cryptomusPost('/v1/payment', {
//       amount: String(amount),
//       currency, network, order_id,
//       url_callback: `${BASE_URL}/api/cryptomus/webhook`
//     });
//     await rtdb.ref(`deposits/${userId}/${order_id}`).set({
//       id: order_id, userId, amount:Number(amount), currency, network,
//       address: result.address, url: result.url, status:'check', created: Date.now()
//     });
//     res.json({ id: order_id, address: result.address, url: result.url });
//   }catch(e){ res.status(400).json({message:e.message}); }
// });

// Webhook: verify signature and credit balance
app.post('/api/cryptomus/webhook', async (req, res)=>{
  try{
    const raw = JSON.stringify(req.body || {});
    const headerSign = req.headers['sign'] || req.headers['signature'];
    if(!headerSign) throw new Error('Missing sign header');
    const expected = md5(Buffer.from(raw).toString('base64') + CRYPTOMUS_API_KEY);
    if(expected !== headerSign) throw new Error('Invalid signature');

    const data = req.body;
    // Static wallet webhook contains order_id, amount, currency, network, status, txid, address
    const { order_id, currency, network, amount, status, address } = data;

    // Extract userId from our composed order_id
    const [userId] = String(order_id||'').split('-');
    if(!userId) throw new Error('No userId in order_id');

    // Update deposit record
    const depRef = rtdb.ref(`deposits/${userId}/${order_id}`);
    await depRef.update({
      status, currency, network, address, txid: data.txid || null,
      payment_amount: Number(amount)||0,
      updated: Date.now()
    });

    // If paid or paid_over -> credit balance
    if(status==='paid' || status==='paid_over'){
      await rtdb.ref(`users/${userId}/balance`).transaction((bal)=>{
        const cur = Number(bal)||0; return cur + (Number(amount)||0);
      });
    }

    res.json({ok:true});
  } catch(e){ console.error('Webhook error:', e.message); res.status(400).json({ok:false, message:e.message}); }
});

app.get('/', (_,res)=>res.send('Cryptomus proxy running'));

app.listen(PORT, ()=> console.log(`Server listening on ${PORT}. Webhook: ${BASE_URL}/api/cryptomus/webhook`));
</script></body>
</html> 
